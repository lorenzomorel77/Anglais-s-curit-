<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Mayor: Mission Sécurité</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-900 text-slate-800 min-h-screen flex items-center justify-center p-4">

    <div id="root" class="w-full max-w-md"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- DONNÉES DU JEU (20 SCÉNARIOS - ENRICHIS AVEC LE PDF) ---
        const SCENARIOS = [
            {
                id: 1,
                title: "Rodéos Urbains",
                description: "Des nuisances sonores et des conduites dangereuses (motos, quads) sont signalées. Les riverains sont excédés.",
                image: "III) Delinquency Rodéo_page-0001.jpg",
                fallbackIcon: "fa-motorcycle",
                choices: [
                    { 
                        text: "Intervention Policière Musclée", 
                        impact: { budget: -10, pop: -5, sec: +15 },
                        feedback: "Risqué. Comme à Villiers-le-Bel (2007), le 'contact tactique' peut provoquer des accidents graves et des émeutes, même si l'interpellation est immédiate."
                    },
                    { 
                        text: "Aménagements Urbains Dissuasifs", 
                        impact: { budget: -15, pop: +5, sec: +20 },
                        feedback: "Excellent choix. Comme à Ternay (Rhône), l'installation d'obstacles physiques (chicanes, rochers) empêche techniquement la prise de vitesse sans risque de confrontation directe."
                    },
                    { 
                        text: "Vidéo-verbalisation & Saisies", 
                        impact: { budget: -5, pop: +10, sec: +10 },
                        feedback: "Bonne approche légale. La loi de 2018 permet la confiscation des véhicules. C'est moins dangereux que la poursuite, mais cela demande d'identifier les auteurs (souvent cagoulés)."
                    }
                ]
            },
            {
                id: 2,
                title: "Invasion de Rats & Propreté",
                description: "Prolifération de rongeurs et dépôts sauvages. Risque sanitaire élevé.",
                image: "IA Nuisibles_page-0001.jpg",
                fallbackIcon: "fa-bug",
                choices: [
                    { 
                        text: "Dératisation Chimique Massive", 
                        impact: { budget: -10, pop: 0, sec: +5 },
                        feedback: "Efficace à court terme mais ne traite pas la cause racine (la nourriture accessible)."
                    },
                    { 
                        text: "Bornes enterrées & PV Ciblés", 
                        impact: { budget: -20, pop: +15, sec: +10 },
                        feedback: "Très bien. Inspiré du Plan Propreté de Paris : limiter l'accès aux déchets (nourriture) via des bornes enterrées est la meilleure prévention durable."
                    },
                    { 
                        text: "Campagne d'affichage", 
                        impact: { budget: -2, pop: -5, sec: 0 },
                        feedback: "Insuffisant. La sensibilisation seule ne suffit pas face à une crise sanitaire installée."
                    }
                ]
            },
            {
                id: 3,
                title: "Stationnement Anarchique",
                description: "Trottoirs envahis, piétons en danger, visibilité réduite aux carrefours.",
                image: "3 - stationnement sauvage_page-0001.jpg",
                fallbackIcon: "fa-square-parking",
                choices: [
                    { 
                        text: "Tolérance Zéro (Enlèvement)", 
                        impact: { budget: +5, pop: -20, sec: +10 },
                        feedback: "Efficace pour l'ordre, mais très impopulaire sans alternative de stationnement proposée."
                    },
                    { 
                        text: "Potelets & Réaménagement", 
                        impact: { budget: -10, pop: -5, sec: +15 },
                        feedback: "La prévention physique (potelets) empêche physiquement l'infraction. Comme à Nantes (Feydeau), cela sécurise les piétons définitivement."
                    },
                    { 
                        text: "Créer un Parking Relais (P+R)", 
                        impact: { budget: -25, pop: +20, sec: +5 },
                        feedback: "Solution idéale mais coûteuse. Déplacer les voitures en périphérie libère le centre-ville durablement."
                    }
                ]
            },
            {
                id: 4,
                title: "Rassemblements Tuning (Rasso)",
                description: "Parking de supermarché occupé le vendredi soir. Drifts et bruit.",
                image: "III) Delinquency Rasso_page-0001.jpg",
                fallbackIcon: "fa-car-burst",
                choices: [
                    { 
                        text: "Fermeture physique du parking", 
                        impact: { budget: -5, pop: +5, sec: +15 },
                        feedback: "Simple et efficace (Barrières, blocs béton comme à Copenhague). Si le lieu n'est pas accessible, le rasso ne peut pas avoir lieu."
                    },
                    { 
                        text: "Organiser un événement encadré", 
                        impact: { budget: -10, pop: +10, sec: +5 },
                        feedback: "Approche 'Montréal' : créer une alternative légale sur circuit sécurisé réduit les courses sauvages en ville."
                    },
                    { 
                        text: "Descente de police", 
                        impact: { budget: -10, pop: -10, sec: +5 },
                        feedback: "Jeu du chat et de la souris. Ils partiront pour revenir ou aller sur le parking voisin."
                    }
                ]
            },
            {
                id: 5,
                title: "Sans-abri en Centre-ville",
                description: "Augmentation de la précarité visible. Tensions avec les commerçants.",
                image: "homeless.jpg",
                fallbackIcon: "fa-person-shelter",
                choices: [
                    { 
                        text: "Arrêtés anti-mendicité", 
                        impact: { budget: 0, pop: -15, sec: 0 },
                        feedback: "Inefficace et juridique contestable. On déplace juste la misère de 500 mètres."
                    },
                    { 
                        text: "Centre d'hébergement d'urgence", 
                        impact: { budget: -15, pop: +5, sec: +10 },
                        feedback: "Nécessaire pour la survie, mais souvent saturé et ne règle pas l'insertion à long terme."
                    },
                    { 
                        text: "Logement d'abord (Housing First)", 
                        impact: { budget: -20, pop: +15, sec: +15 },
                        feedback: "La meilleure approche (modèle finlandais). Fournir un logement stable est la première étape vers la réinsertion, avant même le soin."
                    }
                ]
            },
            {
                id: 6,
                title: "Prostitution de Rue",
                description: "Réseaux installés dans une zone résidentielle. Nuisances et insécurité.",
                image: "III) Delinquency Prostituée_page-0001.jpg",
                fallbackIcon: "fa-person-dress",
                choices: [
                    { 
                        text: "Créer une 'Zone de tolérance'", 
                        impact: { budget: -10, pop: -20, sec: -5 },
                        feedback: "Impossible en France (Position abolitionniste). Cela créerait un vide juridique et validerait le proxénétisme."
                    },
                    { 
                        text: "Ingénierie Urbaine (Éclairage/Voirie)", 
                        impact: { budget: -10, pop: +5, sec: +10 },
                        feedback: "Bonne approche indirecte. Gêner le stationnement des clients et éclairer les zones sombres réduit l'activité sans confrontation."
                    },
                    { 
                        text: "Accompagnement Social (Amicale du Nid)", 
                        impact: { budget: -10, pop: +10, sec: +5 },
                        feedback: "Indispensable. Comme à Montpellier avec l'Amicale du Nid, il faut offrir des parcours de sortie (logement, santé) aux victimes."
                    }
                ]
            },
            {
                id: 7,
                title: "Drogues et Squat de Hall",
                description: "Points de deal installés dans les parties communes.",
                image: "III) Delinquency Alcool et drogue_page-0001.jpg",
                fallbackIcon: "fa-pills",
                choices: [
                    { 
                        text: "Opération Police 'Place Nette'", 
                        impact: { budget: -15, pop: +5, sec: +15 },
                        feedback: "Rassure temporairement, mais le trafic se reconstitue vite (effet ballon de baudruche)."
                    },
                    { 
                        text: "Rénovation Urbaine (Résidentialisation)", 
                        impact: { budget: -25, pop: +15, sec: +20 },
                        feedback: "Approche structurelle (Jane Jacobs). Ouvrir les halls, supprimer les recoins, remettre de la 'surveillance naturelle' par les habitants."
                    },
                    { 
                        text: "Médiateurs de rue", 
                        impact: { budget: -5, pop: +5, sec: 0 },
                        feedback: "Utile pour le lien social, mais impuissant face à des réseaux criminels organisés."
                    }
                ]
            },
            {
                id: 8,
                title: "Blanchiment d'Argent",
                description: "Des snacks et barbiers vides ouvrent partout. Soupçons de blanchiment.",
                image: "III) Delinquency Blanchiment d_argent_page-0001.jpg",
                fallbackIcon: "fa-money-bill-transfer",
                choices: [
                    { 
                        text: "Ne rien faire (Pas de preuves)", 
                        impact: { budget: 0, pop: -10, sec: -10 },
                        feedback: "Erreur. Cela fragilise l'économie légale et laisse les mafias s'installer."
                    },
                    { 
                        text: "Droit de Préemption Commercial", 
                        impact: { budget: -20, pop: +10, sec: +15 },
                        feedback: "Proactif. La mairie rachète les murs pour installer des commerces qualitatifs et diversifiés."
                    },
                    { 
                        text: "Contrôles Administratifs (CODAF)", 
                        impact: { budget: -5, pop: +5, sec: +20 },
                        feedback: "Le levier administratif (hygiène, travail dissimulé, URSSAF) est l'arme la plus efficace pour fermer rapidement ces établissements."
                    }
                ]
            },
            {
                id: 9,
                title: "Harcèlement de Rue",
                description: "Sentiment d'insécurité pour les femmes, notamment près de la gare.",
                image: "2- Arret de nuit_page-0001.jpg",
                fallbackIcon: "fa-person-harassing",
                choices: [
                    { 
                        text: "Marches Exploratoires", 
                        impact: { budget: -5, pop: +15, sec: +10 },
                        feedback: "Excellente méthode participative. Les usagères identifient elles-mêmes les lieux anxiogènes pour guider les aménagements."
                    },
                    { 
                        text: "Application d'alerte", 
                        impact: { budget: -10, pop: +5, sec: 5 },
                        feedback: "Rassurant technologiquement, mais ne règle pas le problème de l'environnement hostile."
                    },
                    { 
                        text: "Patrouilles en civil", 
                        impact: { budget: -15, pop: 0, sec: +15 },
                        feedback: "Permet le flagrant délit, mais n'améliore pas le sentiment de sécurité global au quotidien."
                    }
                ]
            },
            {
                id: 10,
                title: "Cambriolages",
                description: "Vague de vols dans les zones pavillonnaires.",
                image: "III) Delinquency Cambriolage_page-0001.jpg",
                fallbackIcon: "fa-mask",
                choices: [
                    { 
                        text: "Dispositif 'Voisins Vigilants'", 
                        impact: { budget: -2, pop: +5, sec: +15 },
                        feedback: "Très efficace (Participation Citoyenne). La surveillance naturelle du voisinage dissuade mieux que les grilles."
                    },
                    { 
                        text: "Vidéoprotection de voie publique", 
                        impact: { budget: -20, pop: -5, sec: +10 },
                        feedback: "Aide à l'élucidation a posteriori, mais empêche rarement le vol sur le moment."
                    },
                    { 
                        text: "Police Montée (Chevaux)", 
                        impact: { budget: -15, pop: +15, sec: +5 },
                        feedback: "Bon pour l'image et la hauteur de vue, mais peu adapté pour intervenir rapidement dans les jardins privés."
                    }
                ]
            },
            {
                id: 11,
                title: "Squat / Bidonville",
                description: "Campement illicite sur terrain vague. Conditions indignes.",
                image: "III) Delinquency Bidonville_page-0001.jpg",
                fallbackIcon: "fa-tents",
                choices: [
                    { 
                        text: "Expulsion Sèche (Bulldozer)", 
                        impact: { budget: -10, pop: -10, sec: -5 },
                        feedback: "Inefficace. Le campement se reformera 2km plus loin dans des conditions pires. C'est juste un déplacement du problème."
                    },
                    { 
                        text: "Village de Transition (Type 'La Rauze')", 
                        impact: { budget: -25, pop: +10, sec: +20 },
                        feedback: "Modèle exemplaire (Montpellier). Hébergement temporaire encadré, scolarisation et insertion. Permet de résorber le bidonville durablement."
                    },
                    { 
                        text: "Laisser faire (Tolérance)", 
                        impact: { budget: 0, pop: -15, sec: -15 },
                        feedback: "Dangereux. Les risques sanitaires (incendie, maladies) et les tensions avec le voisinage vont exploser."
                    }
                ]
            },
            {
                id: 12,
                title: "Trafic d'Armes",
                description: "Signalements inquiétants de circulation d'armes.",
                image: "III) Delinquency Traffic arme_page-0001.jpg",
                fallbackIcon: "fa-gun",
                choices: [
                    { 
                        text: "Armer la Police Municipale", 
                        impact: { budget: -15, pop: -5, sec: +10 },
                        feedback: "Protège vos agents, mais ne lutte pas contre le trafic lui-même."
                    },
                    { 
                        text: "Coopération État (PJ/Douanes)", 
                        impact: { budget: -5, pop: +5, sec: +25 },
                        feedback: "Indispensable. C'est du grand banditisme, compétence de l'État. Le Maire doit faciliter l'enquête (renseignement, vidéo)."
                    },
                    { 
                        text: "Campagne 'Déposez vos armes'", 
                        impact: { budget: -5, pop: +5, sec: 0 },
                        feedback: "Symbolique. Marche pour les vieux fusils de chasse, pas pour les Kalachnikovs des trafiquants."
                    }
                ]
            },
            {
                id: 13,
                title: "Vols de Véhicules",
                description: "Augmentation des vols de voitures et vols à la roulotte.",
                image: "III) Delinquency Vol et dégradation_page-0001.jpg",
                fallbackIcon: "fa-car-side",
                choices: [
                    { 
                        text: "Caméras LAPI (Plaques)", 
                        impact: { budget: -20, pop: +5, sec: +20 },
                        feedback: "Technologie redoutable (Lecture Automatique des Plaques). Permet de repérer immédiatement un véhicule volé entrant ou sortant de la ville."
                    },
                    { 
                        text: "Marquage des vitres/pièces", 
                        impact: { budget: -5, pop: +5, sec: +5 },
                        feedback: "Prévention utile (comme à New York). Rend la revente des pièces détachées plus difficile."
                    },
                    { 
                        text: "Patrouilles aléatoires", 
                        impact: { budget: -10, pop: 0, sec: +5 },
                        feedback: "Faible probabilité de tomber sur le flagrant délit au bon moment."
                    }
                ]
            },
            {
                id: 14,
                title: "Sécurité Événementielle (Attentats)",
                description: "Grand festival prévu. Menace terroriste élevée.",
                image: "III) Delinquency Attentats_page-0001.jpg",
                fallbackIcon: "fa-person-military-rifle",
                choices: [
                    { 
                        text: "Annulation pure et simple", 
                        impact: { budget: -5, pop: -25, sec: +30 },
                        feedback: "Risque zéro, mais victoire psychologique pour les terroristes. La vie s'arrête."
                    },
                    { 
                        text: "Perimétrage 'Fan Zone' (Béton/Fouilles)", 
                        impact: { budget: -25, pop: +5, sec: +15 },
                        feedback: "Le standard actuel. Sécuriser le périmètre (barrières anti-bélier) tout en maintenant la fête."
                    },
                    { 
                        text: "Vidéosurveillance IA", 
                        impact: { budget: -30, pop: -10, sec: +10 },
                        feedback: "Technologie prometteuse (détection comportements suspects) mais pose des questions éthiques et juridiques."
                    }
                ]
            },
            {
                id: 15,
                title: "Risque Inondation (Cévenol)",
                description: "Alerte orange. Les rivières (Lez, Mosson) montent vite.",
                image: "IV) Amenagement Chausée déformée_page-0001.jpg",
                fallbackIcon: "fa-house-flood-water",
                choices: [
                    { 
                        text: "Fermeture préventive des axes", 
                        impact: { budget: -5, pop: -5, sec: +25 },
                        feedback: "Vital. Utiliser des barrières dynamiques pour empêcher les voitures de s'engager sur les berges submersibles."
                    },
                    { 
                        text: "Attendre la montée des eaux", 
                        impact: { budget: 0, pop: 0, sec: -30 },
                        feedback: "Criminel. Les crues méditerranéennes sont trop rapides. C'est là qu'il y a des morts."
                    },
                    { 
                        text: "Campagne d'adhérence routière", 
                        impact: { budget: -10, pop: +5, sec: +5 },
                        feedback: "Bonne prévention long terme (éviter les glissades post-crue), mais ne gère pas l'urgence vitale."
                    }
                ]
            },
            {
                id: 16,
                title: "Logement Insalubre",
                description: "Immeuble dégradé, marchands de sommeil, enfants asthmatiques.",
                image: "IV) Amenagement Logement insalubre_page-0001.jpg",
                fallbackIcon: "fa-house-crack",
                choices: [
                    { 
                        text: "Signalement ARS & Procureur", 
                        impact: { budget: -5, pop: +5, sec: +15 },
                        feedback: "La voie légale. Permet de saisir les biens du marchand de sommeil et de forcer les travaux."
                    },
                    { 
                        text: "Relogement d'urgence hôtel", 
                        impact: { budget: -15, pop: +5, sec: +5 },
                        feedback: "Solution temporaire coûteuse qui ne règle pas le problème du bâti."
                    },
                    { 
                        text: "Opération Rénovation Façades", 
                        impact: { budget: -20, pop: +15, sec: 0 },
                        feedback: "Esthétique. Ne règle pas l'insalubrité intérieure (plomb, humidité) qui rend les gens malades."
                    }
                ]
            },
            {
                id: 17,
                title: "Manifestations Tendues",
                description: "Cortège prévu en centre-ville. Risque de casse.",
                image: "protest.jpg",
                fallbackIcon: "fa-bullhorn",
                choices: [
                    { 
                        text: "Interdire la manifestation", 
                        impact: { budget: 0, pop: -20, sec: +5 },
                        feedback: "Risqué. Transforme souvent une manif déclarée en émeute sauvage incontrôlable."
                    },
                    { 
                        text: "Négocier le parcours en amont", 
                        impact: { budget: -5, pop: +10, sec: +15 },
                        feedback: "La meilleure méthode. S'accorder avec les organisateurs sur un tracé sécurisable évite les débordements."
                    },
                    { 
                        text: "Faire intervenir les CRS d'emblée", 
                        impact: { budget: -10, pop: -10, sec: +5 },
                        feedback: "Escalade de la violence assurée. Le maintien de l'ordre doit être gradué."
                    }
                ]
            },
            {
                id: 18,
                title: "Vie Nocturne & Éclairage",
                description: "Zones sombres anxiogènes. Les habitants n'osent plus sortir.",
                image: "Pas d_éclairage_page-0001.jpg",
                fallbackIcon: "fa-lightbulb",
                choices: [
                    { 
                        text: "Projecteurs surpuissants partout", 
                        impact: { budget: -15, pop: -5, sec: +5 },
                        feedback: "Pollution lumineuse et peu efficace. Ce n'est pas la quantité de lumière qui compte, mais sa qualité."
                    },
                    { 
                        text: "Approche 'ToNite' (Turin)", 
                        impact: { budget: -20, pop: +20, sec: +20 },
                        feedback: "Excellent modèle. On ne fait pas que mettre de la lumière, on réoccupe l'espace par des activités sociales nocturnes positives."
                    },
                    { 
                        text: "Couvre-feu partiel", 
                        impact: { budget: 0, pop: -25, sec: +10 },
                        feedback: "Liberticide. La ville meurt, et les rues vides deviennent encore plus dangereuses."
                    }
                ]
            },
            {
                id: 19,
                title: "Gens du Voyage / Nomades",
                description: "Installation illicite sur le stade municipal.",
                image: "caravan.jpg",
                fallbackIcon: "fa-caravan",
                choices: [
                    { 
                        text: "Blocage (Tranchées/Pierres)", 
                        impact: { budget: -10, pop: -5, sec: -5 },
                        feedback: "Souvent contourné. Crée un climat de guerre de position."
                    },
                    { 
                        text: "Aire d'Accueil Intégrée (Nantes)", 
                        impact: { budget: -20, pop: +10, sec: +15 },
                        feedback: "La solution durable. Des aires de qualité, intégrées à la ville (pas rejetées au loin), réduisent les installations sauvages."
                    },
                    { 
                        text: "Coupure eau/électricité", 
                        impact: { budget: 0, pop: -10, sec: -15 },
                        feedback: "Illégal et contre-productif. Augmente les risques sanitaires et la colère, sans faire partir les caravanes."
                    }
                ]
            },
            {
                id: 20,
                title: "Friches Urbaines",
                description: "Ancienne usine abandonnée, squatée et polluée.",
                image: "IA Dechets_page-0001.jpg",
                fallbackIcon: "fa-industry",
                choices: [
                    { 
                        text: "Murer les accès", 
                        impact: { budget: -5, pop: 0, sec: +5 },
                        feedback: "Temporaire. Les murs sont vite percés si le lieu reste vide."
                    },
                    { 
                        text: "Réhabilitation Participative (Case-Navire)", 
                        impact: { budget: -15, pop: +20, sec: +20 },
                        feedback: "Visionnaire ! Transformer la friche en lieu de vie (agriculture urbaine, culturel) avec les habitants supprime l'insécurité par l'occupation positive."
                    },
                    { 
                        text: "Vendre à un promoteur privé", 
                        impact: { budget: +20, pop: -5, sec: +10 },
                        feedback: "Bon pour les finances, mais risque de gentrification ou de projet déconnecté des besoins du quartier."
                    }
                ]
            }
        ];

        // --- COMPOSANTS ---

        // Gestionnaire d'image avec Fallback automatique
        const SmartImage = ({ src, fallbackIcon, alt }) => {
            const [hasError, setHasError] = useState(false);

            if (hasError) {
                return (
                    <div className="w-full h-40 bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center rounded-lg shadow-inner mb-4">
                        <i className={`fa-solid ${fallbackIcon} text-5xl text-white opacity-80 drop-shadow-lg`}></i>
                    </div>
                );
            }

            return (
                <div className="w-full h-40 overflow-hidden rounded-lg mb-4 bg-slate-200 relative group">
                    <img 
                        src={src} 
                        alt={alt} 
                        className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                        onError={() => setHasError(true)}
                    />
                    <div className="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors"></div>
                </div>
            );
        };

        const Gauge = ({ label, value, color, icon }) => {
            let colorClass = "bg-green-500";
            if (value < 50) colorClass = "bg-yellow-500";
            if (value < 20) colorClass = "bg-red-600";
            if (color) colorClass = color;

            return (
                <div className="flex flex-col w-full mb-2">
                    <div className="flex justify-between text-xs font-bold text-slate-300 mb-1">
                        <span className="flex items-center gap-1"><i className={`fa-solid ${icon}`}></i> {label}</span>
                        <span>{Math.round(value)}%</span>
                    </div>
                    <div className="w-full bg-slate-700 rounded-full h-2.5 overflow-hidden">
                        <div className={`${colorClass} h-2.5 rounded-full transition-all duration-700 ease-out`} style={{ width: `${Math.max(0, Math.min(100, value))}%` }}></div>
                    </div>
                </div>
            );
        };

        // --- MODAL DE FEEDBACK AMÉLIORÉ ---
        const FeedbackModal = ({ feedback, impacts, onNext }) => {
            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 modal-enter">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-600">
                        {/* Header */}
                        <div className="bg-blue-600 p-4 text-white flex justify-between items-center">
                            <h3 className="font-bold text-lg"><i className="fa-solid fa-clipboard-check mr-2"></i>Rapport d'Intervention</h3>
                        </div>

                        {/* Body */}
                        <div className="p-6">
                            <div className="mb-6">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Analyse de l'expert</h4>
                                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded text-slate-700 text-sm italic leading-relaxed">
                                    "{feedback}"
                                </div>
                            </div>

                            <div className="mb-6">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Impact Immédiat</h4>
                                <div className="grid grid-cols-3 gap-3">
                                    <div className={`p-3 rounded-lg text-center ${impacts.budget > 0 ? 'bg-green-100 text-green-700' : impacts.budget < 0 ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-500'}`}>
                                        <div className="text-xs font-bold">Budget</div>
                                        <div className="text-lg font-bold">{impacts.budget > 0 ? '+' : ''}{impacts.budget}</div>
                                    </div>
                                    <div className={`p-3 rounded-lg text-center ${impacts.pop > 0 ? 'bg-green-100 text-green-700' : impacts.pop < 0 ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-500'}`}>
                                        <div className="text-xs font-bold">Pop.</div>
                                        <div className="text-lg font-bold">{impacts.pop > 0 ? '+' : ''}{impacts.pop}</div>
                                    </div>
                                    <div className={`p-3 rounded-lg text-center ${impacts.sec > 0 ? 'bg-green-100 text-green-700' : impacts.sec < 0 ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-500'}`}>
                                        <div className="text-xs font-bold">Sécu.</div>
                                        <div className="text-lg font-bold">{impacts.sec > 0 ? '+' : ''}{impacts.sec}</div>
                                    </div>
                                </div>
                            </div>

                            <button onClick={onNext} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                                Dossier Suivant <i className="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Button = ({ children, onClick, variant = "primary", className = "" }) => {
            const baseStyle = "w-full py-3 px-4 rounded-lg font-bold transition transform hover:scale-[1.02] active:scale-95 shadow-md flex items-center justify-center gap-2 text-sm";
            const variants = {
                primary: "bg-blue-600 hover:bg-blue-500 text-white border-b-4 border-blue-800",
                secondary: "bg-slate-600 hover:bg-slate-500 text-white border-b-4 border-slate-800",
                choice: "bg-white hover:bg-blue-50 text-slate-700 border border-slate-200 hover:border-blue-400 text-left justify-start h-auto py-4"
            };
            return (
                <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        // --- MOTEUR DU JEU ---

        const App = () => {
            const [screen, setScreen] = useState('start'); // start, game, end
            const [showFeedback, setShowFeedback] = useState(false);
            const [stats, setStats] = useState({ budget: 50, pop: 50, sec: 50 });
            const [scenarioIndex, setScenarioIndex] = useState(0);
            const [lastChoice, setLastChoice] = useState(null);

            const currentScenario = SCENARIOS[scenarioIndex];

            const handleChoice = (choice) => {
                const newStats = {
                    budget: Math.min(100, Math.max(0, stats.budget + choice.impact.budget)),
                    pop: Math.min(100, Math.max(0, stats.pop + choice.impact.pop)),
                    sec: Math.min(100, Math.max(0, stats.sec + choice.impact.sec)),
                };
                setStats(newStats);
                setLastChoice(choice);
                setShowFeedback(true);
            };

            const nextScenario = () => {
                setShowFeedback(false);
                if (scenarioIndex + 1 < SCENARIOS.length) {
                    setScenarioIndex(scenarioIndex + 1);
                } else {
                    setScreen('end');
                }
            };

            const calculateRank = () => {
                const total = stats.budget + stats.pop + stats.sec;
                if (total < 120) return "Maire Débutant";
                if (total < 200) return "Maire Gestionnaire";
                if (total < 260) return "Maire Engagé";
                return "Maire Visionnaire";
            };

            // ÉCRAN ACCUEIL
            if (screen === 'start') {
                return (
                    <div className="bg-white rounded-xl shadow-2xl p-8 text-center max-w-lg fade-in border-t-4 border-blue-600 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500"></div>
                        <div className="mb-6 inline-block p-4 bg-blue-50 rounded-full">
                            <i className="fa-solid fa-city text-5xl text-blue-600"></i>
                        </div>
                        <h1 className="text-3xl font-extrabold text-slate-800 mb-2 tracking-tight">URBAN MAYOR</h1>
                        <h2 className="text-lg font-semibold text-blue-600 mb-6 uppercase tracking-widest">Mission Sécurité</h2>
                        <p className="text-slate-600 mb-8 leading-relaxed">
                            Vous êtes le nouveau maire. 20 dossiers brûlants vous attendent.
                            <br/><br/>
                            Chaque décision impacte votre <strong>Budget</strong>, votre <strong>Popularité</strong> et la <strong>Sécurité</strong> réelle.
                            <br/><br/>
                            <em className="text-sm text-slate-500">Basé sur des cas réels et des solutions d'urbanisme éprouvées.</em>
                        </p>
                        <Button onClick={() => setScreen('game')}>Prendre mes fonctions</Button>
                    </div>
                );
            }

            // ÉCRAN DE JEU & FEEDBACK
            if (screen === 'game') {
                return (
                    <div className="bg-slate-800 rounded-xl shadow-2xl w-full max-w-md border border-slate-700 fade-in relative min-h-[600px] flex flex-col">
                        
                        {/* MODAL FEEDBACK (Overlay) */}
                        {showFeedback && lastChoice && (
                            <FeedbackModal 
                                feedback={lastChoice.feedback} 
                                impacts={lastChoice.impact} 
                                onNext={nextScenario} 
                            />
                        )}

                        {/* Header Stats */}
                        <div className="bg-slate-900 p-4 border-b border-slate-700 sticky top-0 z-10">
                            <div className="flex justify-between items-end mb-3">
                                <span className="text-white font-bold text-sm bg-slate-700 px-2 py-1 rounded">Dossier {scenarioIndex + 1} / {SCENARIOS.length}</span>
                                <span className="text-slate-400 text-xs uppercase font-semibold tracking-wider">Mairie de Ville-Neuve</span>
                            </div>
                            <div className="grid grid-cols-3 gap-3">
                                <Gauge label="Budget" value={stats.budget} icon="fa-coins" color="bg-amber-400" />
                                <Gauge label="Pop." value={stats.pop} icon="fa-face-smile" color="bg-blue-400" />
                                <Gauge label="Sécu." value={stats.sec} icon="fa-shield-halved" color="bg-emerald-500" />
                            </div>
                        </div>

                        {/* Scenario Card */}
                        <div className="p-5 bg-slate-50 flex-grow flex flex-col">
                            <div className="mb-4">
                                <h2 className="text-lg font-bold text-slate-800 leading-tight mb-1">{currentScenario.title}</h2>
                                <div className="h-1 w-12 bg-blue-500 rounded"></div>
                            </div>
                            
                            <SmartImage 
                                src={currentScenario.image} 
                                fallbackIcon={currentScenario.fallbackIcon} 
                                alt={currentScenario.title} 
                            />

                            <p className="text-slate-600 text-sm mb-6 flex-grow">{currentScenario.description}</p>

                            <div className="space-y-3 mt-auto">
                                <p className="text-xs font-bold text-slate-400 uppercase mb-1">Vos Options :</p>
                                {currentScenario.choices.map((choice, idx) => (
                                    <button 
                                        key={idx}
                                        onClick={() => handleChoice(choice)}
                                        className="w-full text-left p-3 rounded-lg border border-slate-200 bg-white hover:border-blue-500 hover:bg-blue-50 hover:shadow-md transition-all group duration-200"
                                    >
                                        <div className="flex items-start gap-3">
                                            <div className="mt-1 bg-slate-100 text-slate-500 w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold group-hover:bg-blue-500 group-hover:text-white transition-colors">
                                                {String.fromCharCode(65 + idx)}
                                            </div>
                                            <div>
                                                <div className="font-bold text-slate-700 text-sm group-hover:text-blue-700">{choice.text}</div>
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // ÉCRAN FIN
            if (screen === 'end') {
                return (
                    <div className="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-lg fade-in my-8">
                        <div className="bg-slate-900 p-8 text-center text-white relative overflow-hidden">
                            <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/city-fields.png')]"></div>
                            <div className="w-24 h-24 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg ring-4 ring-blue-900/50">
                                <i className="fa-solid fa-city text-4xl"></i>
                            </div>
                            <h2 className="text-xl font-medium text-blue-200 uppercase tracking-widest mb-1">Mandat Terminé</h2>
                            <h1 className="text-3xl font-extrabold text-white">{calculateRank()}</h1>
                        </div>

                        <div className="p-6">
                            <div className="mb-8">
                                <h3 className="font-bold text-slate-800 text-sm uppercase tracking-wide mb-4 border-b pb-2">Bilan Définitif</h3>
                                <div className="space-y-3">
                                    <Gauge label="Santé Financière" value={stats.budget} icon="fa-coins" color="bg-amber-400" />
                                    <Gauge label="Bonheur Citoyen" value={stats.pop} icon="fa-face-smile" color="bg-blue-400" />
                                    <Gauge label="Sécurité Publique" value={stats.sec} icon="fa-shield-halved" color="bg-emerald-500" />
                                </div>
                            </div>

                            <div className="bg-blue-50 p-5 rounded-xl border border-blue-100 mb-6">
                                <h3 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
                                    <i className="fa-solid fa-graduation-cap"></i> Formation Continue
                                </h3>
                                <p className="text-sm text-blue-700/80 mb-4 leading-relaxed">
                                    Ces scénarios sont inspirés de cas réels. Pour approfondir les concepts de prévention situationnelle et d'aménagement :
                                </p>
                                <div className="flex flex-col gap-3">
                                    <a href="GUIDE SÉCURITÉ.pdf" target="_blank" className="flex items-center justify-between p-3 bg-white border border-blue-200 rounded-lg hover:bg-blue-600 hover:text-white hover:border-blue-600 transition group shadow-sm">
                                        <span className="font-semibold text-sm">Lire le Guide Complet</span>
                                        <i className="fa-solid fa-file-pdf group-hover:scale-110 transition-transform"></i>
                                    </a>
                                </div>
                            </div>

                            <Button onClick={() => window.location.reload()} variant="primary">
                                <i className="fa-solid fa-rotate-right"></i> Nouveau Mandat
                            </Button>
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
